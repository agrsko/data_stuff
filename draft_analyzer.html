<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fantasy Football Draft Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
    }
    header {
      background: #111;
      color: #fff;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header a {
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
    }
    main {
      max-width: 900px;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    section {
      padding: 1.5rem 1.5rem 0;
    }
    section:last-of-type {
      padding-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    input, select, button {
      font-family: inherit;
      font-size: 0.95rem;
    }
    input, select {
      padding: 0.25rem 0.4rem;
      margin-top: 0.25rem;
    }
    button {
      margin: 1rem 1.5rem 0;
      padding: 0.4rem 0.8rem;
      border-radius: 4px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .settings-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.5rem;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    .not-found {
      color: #b00020;
      font-size: 0.8rem;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0;font-size:1.3rem;">Fantasy Football Draft Analyzer</h1>
      <p style="margin:0.2rem 0 0;font-size:0.9rem;opacity:0.85;">
        Choose your draft settings, enter your picks, and get grades.
      </p>
    </div>
    <div>
      <a href="index.html">&larr; Back to portfolio</a>
    </div>
  </header>

  <main>
    <!-- Intro -->
    <section>
      <h2>How it works (v1)</h2>
      <p class="small">
        Step 1: Set your draft settings.<br />
        Step 2: Click <strong>Build picks table</strong> to generate one row per round.<br />
        Step 3: Type your players in order. For each player, the tool reads 2024 stats
        and expected totals/averages, computes:
      </p>
      <ul class="small">
        <li><strong>ratioTotal</strong> = Total Points / Expected Total Points</li>
        <li><strong>ratioAvg</strong> = Average Points / Expected Average Points</li>
        <li><strong>Pick Strength</strong> = ratioAvg^0.75 × ratioTotal^0.25</li>
      </ul>
      <p class="small">
        Letter grades are based on Pick Strength (you can tune the thresholds later).
      </p>
    </section>

    <!-- Draft Settings -->
    <section>
      <h3>Draft Settings</h3>
      <div class="settings-row">
        <label>
          Number of teams
          <select id="numTeams">
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12" selected>12</option>
            <option value="14">14</option>
          </select>
        </label>

        <label>
          Pick Slot
          <input type="number" id="pickSlot" min="1" max="14" value="1" />
        </label>

        <label>
          Number of rounds
          <input type="number" id="numRounds" min="1" max="25" value="16" />
        </label>

        <label>
          Draft type
          <select id="draftType">
            <option value="snake" selected>Snake</option>
            <option value="linear">Non-snake (Linear)</option>
          </select>
        </label>
      </div>
      <p class="small">
        These settings let the tool compute each pick&apos;s round and overall draft
        position, so you only have to type in player names.
      </p>

      <button id="buildPicksBtn">Build picks table</button>
    </section>

    <!-- Picks input -->
    <section>
      <h3>Your picks</h3>
      <p class="small">
        After building the picks table, enter the player you drafted in each
        round. Names will autocomplete from the 2024 player list.
      </p>
      <div id="picksTableContainer" class="small">
        <p>No picks yet. Choose your settings and click &ldquo;Build picks table.&rdquo;</p>
      </div>
    </section>

    <button id="analyzeBtn">Analyze draft</button>

    <!-- Results -->
    <section>
      <h3>Pick grades</h3>
      <div id="resultsContainer" class="small">
        <p>No results yet.</p>
      </div>
    </section>
  </main>

  <!-- Autocomplete list for players -->
  <datalist id="playersList"></datalist>

  <script>
    // ---- PLAYER DATA LOADING (from players_2024.json) ----------------------

    let players = [];

    function loadPlayers() {
      return fetch("players_2024.json")
        .then(res => res.json())
        .then(data => {
          // Map your column names (Name, Total Points, etc.) into normalized fields
          players = data.map(original => {
            const p = original;

            const name          = p.name || p.Name;
            const position      = p.position || p.Position;
            const team          = p.team || p.Team || null;
            const totalPoints   = p.totalPoints ?? p["Total Points"];
            const avgPoints     = p.avgPoints ?? p["Average Points"];
            const expectedTotal = p.expectedTotal ?? p["Expected Total Points"];
            const expectedAvg   = p.expectedAvg ?? p["Expected Average Points"];
            const adpOverall    = p.adpOverall ?? p["Overall ADP"] ?? null;

            const ratioTotal =
              expectedTotal && expectedTotal > 0 && totalPoints != null
                ? totalPoints / expectedTotal
                : null;

            const ratioAvg =
              expectedAvg && expectedAvg > 0 && avgPoints != null
                ? avgPoints / expectedAvg
                : null;

            let pickStrength = null;
            if (ratioTotal != null && ratioAvg != null) {
              // PickStrength = ratioAvg^0.75 * ratioTotal^0.25
              pickStrength =
                Math.pow(ratioAvg, 0.75) * Math.pow(ratioTotal, 0.25);
            }

            return {
              ...original,      // keep all original fields too
              name,
              position,
              team,
              adpOverall,
              totalPoints,
              avgPoints,
              expectedTotal,
              expectedAvg,
              ratioTotal,
              ratioAvg,
              pickStrength
            };
          });

          populatePlayerDatalist();
          console.log("Loaded players:", players.length);
        })
        .catch(err => {
          console.error("Error loading players_2024.json", err);
        });
    }

    function populatePlayerDatalist() {
      const list = document.getElementById("playersList");
      if (!list || !players.length) return;
      list.innerHTML = players
        .map(p => `<option value="${p.name}"></option>`)
        .join("");
    }

    function findPlayerByName(name) {
      const clean = name.trim().toLowerCase();
      return players.find(p => p.name && p.name.toLowerCase() === clean) || null;
    }

    // Grades based on pickStrength (you can tune thresholds)
    function gradeFromPickStrength(ps) {
      if (ps == null) return null;
      if (ps >= 1.6932) return "A+";
      if (ps >= 1.4946) return "A";
      if (ps >= 1.3953) return "A-";
      if (ps >= 1.1967) return "B+";
      if (ps >= 1.0974) return "B";
      if (ps >= 0.9981) return "B-";
      if (ps >= 0.8989) return "C+";
      if (ps >= 0.7996) return "C";
      if (ps >= 0.601) return "C-";
      if (ps >= 0.5017) return "D+";
      if (ps >= 0.3031) return "D";
      return "F";
    }

    // ---- DRAFT LAYOUT LOGIC ------------------------------------------------

    function computePickInfo(round, numTeams, slot, draftType) {
      let pickInRound;
      if (draftType === "snake") {
        if (round % 2 === 1) {
          pickInRound = slot;
        } else {
          pickInRound = numTeams - slot + 1;
        }
      } else {
        pickInRound = slot;
      }
      const overall = (round - 1) * numTeams + pickInRound;
      return { pickInRound, overall };
    }

    function buildPicksTable() {
      const numTeams = Number(document.getElementById("numTeams").value);
      const slot = Number(document.getElementById("pickSlot").value);
      const numRounds = Number(document.getElementById("numRounds").value);
      const draftType = document.getElementById("draftType").value;
      const container = document.getElementById("picksTableContainer");

      if (!numTeams || !slot || !numRounds) {
        container.innerHTML = "<p>Please enter valid draft settings first.</p>";
        return;
      }

      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>Round</th><th>Overall Pick</th><th>Player</th>";
      html += "</tr></thead><tbody>";

      for (let r = 1; r <= numRounds; r++) {
        const { pickInRound, overall } = computePickInfo(r, numTeams, slot, draftType);
        html += "<tr>";
        html += `<td>${r}</td>`;
        html += `<td>${overall}</td>`;
        html += `<td><input type="text"
                             class="player-input"
                             data-round="${r}"
                             data-overall="${overall}"
                             data-pick-in-round="${pickInRound}"
                             list="playersList"
                             placeholder="Start typing a player name..." /></td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      container.innerHTML = html;
    }

    // ---- ANALYSIS / GRADING -------------------------------------------------

    function analyzeDraft() {
      const inputs = document.querySelectorAll(".player-input");
      const resultsContainer = document.getElementById("resultsContainer");

      if (!inputs.length) {
        resultsContainer.innerHTML = "<p>Build the picks table and enter players first.</p>";
        return;
      }

      const rows = [];
      inputs.forEach(input => {
        const playerName = input.value.trim();
        if (!playerName) return;

        const round = Number(input.dataset.round);
        const overall = Number(input.dataset.overall);
        const pickInRound = Number(input.dataset["pickInRound"]);

        const player = findPlayerByName(playerName);

        let expectedTotal = null;
        let expectedAvg   = null;
        let actualTotal   = null;
        let actualAvg     = null;
        let ratioTotal    = null;
        let ratioAvg      = null;
        let pickStrength  = null;
        let grade         = null;

        if (player) {
          expectedTotal = player.expectedTotal;
          expectedAvg   = player.expectedAvg;
          actualTotal   = player.totalPoints;
          actualAvg     = player.avgPoints;
          ratioTotal    = player.ratioTotal;
          ratioAvg      = player.ratioAvg;
          pickStrength  = player.pickStrength;
          grade         = gradeFromPickStrength(pickStrength);
        }

        rows.push({
          round,
          overall,
          pickInRound,
          playerName,
          player,
          expectedTotal,
          expectedAvg,
          actualTotal,
          actualAvg,
          ratioTotal,
          ratioAvg,
          pickStrength,
          grade
        });
      });

      if (!rows.length) {
        resultsContainer.innerHTML = "<p>No players entered yet.</p>";
        return;
      }

      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>Round</th><th>Overall</th>";
      html += "<th>Player</th><th>Pos</th>";
      html += "<th>Total</th><th>Avg</th>";
      html += "<th>Exp Total</th><th>Exp Avg</th>";
      html += "<th>ratioTotal</th><th>ratioAvg</th>";
      html += "<th>Pick Strength</th><th>Grade</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(r => {
        const pos = r.player ? r.player.position : "";
        html += "<tr>";
        html += `<td>${r.round}</td>`;
        html += `<td>${r.overall}</td>`;
        html += `<td>${r.playerName}${!r.player ? '<span class="not-found"> (not found)</span>' : ""}</td>`;
        html += `<td>${pos}</td>`;
        html += `<td>${r.actualTotal != null ? r.actualTotal.toFixed(1) : "—"}</td>`;
        html += `<td>${r.actualAvg != null ? r.actualAvg.toFixed(1) : "—"}</td>`;
        html += `<td>${r.expectedTotal != null ? r.expectedTotal.toFixed(1) : "—"}</td>`;
        html += `<td>${r.expectedAvg != null ? r.expectedAvg.toFixed(1) : "—"}</td>`;
        html += `<td>${r.ratioTotal != null ? r.ratioTotal.toFixed(3) : "—"}</td>`;
        html += `<td>${r.ratioAvg != null ? r.ratioAvg.toFixed(3) : "—"}</td>`;
        html += `<td>${r.pickStrength != null ? r.pickStrength.toFixed(3) : "—"}</td>`;
        html += `<td>${r.grade || "—"}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      resultsContainer.innerHTML = html;
    }

    // ---- WIRE UP PAGE ------------------------------------------------------

    document.getElementById("buildPicksBtn").addEventListener("click", buildPicksTable);
    document.getElementById("analyzeBtn").addEventListener("click", analyzeDraft);

    // Load player data when page loads
    loadPlayers();
  </script>
</body>
</html>

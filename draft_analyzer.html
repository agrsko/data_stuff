<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Fantasy Football Draft Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
    }
    header {
      background: #111;
      color: #fff;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header a {
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
    }
    main {
      max-width: 960px;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem 1.5rem;
      background: #fff;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
    h1, h2, h3 {
      margin-top: 0;
    }
    section {
      padding: 1.5rem 1.5rem 0;
    }
    section:last-of-type {
      padding-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    input, select, button {
      font-family: inherit;
      font-size: 0.95rem;
    }
    input, select {
      padding: 0.25rem 0.4rem;
      margin-top: 0.25rem;
    }
    button {
      margin: 1rem 1.5rem 0;
      padding: 0.45rem 1rem;
      border-radius: 4px;
      border: 1px solid #111;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    .settings-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.35rem 0.5rem;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .not-found {
      color: #b00020;
      font-size: 0.8rem;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0;font-size:1.3rem;">Fantasy Football Draft Analyzer</h1>
      <p style="margin:0.2rem 0 0;font-size:0.9rem;opacity:0.85;">
        Choose your draft settings, enter your picks, and get weighted draft grades.
      </p>
    </div>
    <div>
      <a href="index.html">&larr; Back to portfolio</a>
    </div>
  </header>

  <main>
    <!-- Intro -->
    <section>
      <h2>How it works</h2>
      <p class="small">
        1. Set your draft settings and build the picks table.<br />
        2. Type in the player you drafted at each pick (autocomplete from 2020–2024 data).<br />
        3. The tool pulls each player’s actual vs expected points, computes:
      </p>
      <ul class="small">
        <li><strong>ratioTotal</strong> = Total Points / Expected Total Points</li>
        <li><strong>ratioAvg</strong> = Average Points / Expected Average Points</li>
        <li><strong>Pick Strength</strong> = ratioAvg<sup>0.75</sup> × ratioTotal<sup>0.25</sup></li>
        <li><strong>Pick Weight</strong> from your pick value chart (1–180)</li>
        <li><strong>Weighted Strength</strong> = Pick Strength × Pick Weight</li>
      </ul>
      <p class="small">
        Letter grades are based on Pick Strength (you can tweak thresholds in the code).
      </p>
    </section>

    <!-- Draft Settings -->
    <section>
      <h3>Draft Settings</h3>
      <div class="settings-row">
        <label>
          Number of teams
          <select id="numTeams">
            <option value="6">6</option>
            <option value="8">8</option>
            <option value="10">10</option>
            <option value="12" selected>12</option>
            <option value="14">14</option>
          </select>
        </label>

        <label>
          Pick Slot
          <input type="number" id="pickSlot" min="1" max="14" value="1" />
        </label>

        <label>
          Number of rounds
          <input type="number" id="numRounds" min="1" max="25" value="16" />
        </label>

        <label>
          Draft type
          <select id="draftType">
            <option value="snake" selected>Snake</option>
            <option value="linear">Non-snake (Linear)</option>
          </select>
        </label>
      </div>
      <p class="small">
        These settings determine the overall pick numbers so the tool can apply your pick value weights.
      </p>

      <button id="buildPicksBtn">Build picks table</button>
    </section>

    <!-- Picks input -->
    <section>
      <h3>Your picks</h3>
      <p class="small">
        After building the picks table, enter the player you drafted at each pick. Names autocomplete from the player list.
      </p>
      <div id="picksTableContainer" class="small">
        <p>No picks yet. Choose your settings and click &ldquo;Build picks table.&rdquo;</p>
      </div>
    </section>

    <button id="analyzeBtn">Analyze draft</button>

    <!-- Results -->
    <section>
      <h3>Pick grades</h3>
      <div id="resultsContainer" class="small">
        <p>No results yet.</p>
      </div>
    </section>
  </main>

  <!-- Autocomplete list for players -->
  <datalist id="playersList"></datalist>

  <script>
    // ------------------ GLOBAL DATA ------------------

    let players = [];      // from players_2024.json
    let pickWeights = {};  // from pick_values.json
    let minPick = null;
    let maxPick = null;

    // ------------------ PLAYER DATA LOADING ------------------

    function loadPlayers() {
      return fetch("players_2024.json")
        .then(res => res.json())
        .then(data => {
          players = data.map(original => {
            const p = original;

            const name          = p.name || p.Name;
            const position      = p.position || p.Position;
            const team          = p.team || p.Team || null;
            const totalPoints   = p.totalPoints ?? p["Total Points"];
            const avgPoints     = p.avgPoints ?? p["Average Points"];
            const expectedTotal = p.expectedTotal ?? p["Expected Total Points"];
            const expectedAvg   = p.expectedAvg ?? p["Expected Average Points"];
            const adpOverall    = p.adpOverall ?? p["Overall ADP"] ?? null;

            const ratioTotal =
              expectedTotal && expectedTotal > 0 && totalPoints != null
                ? totalPoints / expectedTotal
                : null;

            const ratioAvg =
              expectedAvg && expectedAvg > 0 && avgPoints != null
                ? avgPoints / expectedAvg
                : null;

            let pickStrength = null;
            if (ratioTotal != null && ratioAvg != null) {
              // PickStrength = ratioAvg^0.75 * ratioTotal^0.25
              pickStrength =
                Math.pow(ratioAvg, 0.75) * Math.pow(ratioTotal, 0.25);
            }

            return {
              ...original,      // keep original fields
              name,
              position,
              team,
              adpOverall,
              totalPoints,
              avgPoints,
              expectedTotal,
              expectedAvg,
              ratioTotal,
              ratioAvg,
              pickStrength
            };
          });

          populatePlayerDatalist();
          console.log("Loaded players:", players.length);
        })
        .catch(err => {
          console.error("Error loading players_2024.json", err);
        });
    }

    function populatePlayerDatalist() {
      const list = document.getElementById("playersList");
      if (!list || !players.length) return;
      list.innerHTML = players
        .map(p => p.name ? `<option value="${p.name}"></option>` : "")
        .join("");
    }

    function findPlayerByName(name) {
      const clean = name.trim().toLowerCase();
      return players.find(
        p => p.name && p.name.toLowerCase() === clean
      ) || null;
    }

    // ------------------ PICK VALUE LOADING ------------------

    function loadPickValues() {
      return fetch("pick_values.json")
        .then(res => res.json())
        .then(data => {
          pickWeights = {};
          data.forEach(row => {
            const pick = Number(row.Pick);
            const weight = Number(row.Weight);
            if (!Number.isNaN(pick) && !Number.isNaN(weight)) {
              pickWeights[pick] = weight;
            }
          });
          const keys = Object.keys(pickWeights).map(Number);
          minPick = Math.min(...keys);
          maxPick = Math.max(...keys);
          console.log("Loaded pick weights for", keys.length, "picks");
          console.log("Example weights:", {
            1: pickWeights[1],
            2: pickWeights[2],
            8: pickWeights[8],
            24: pickWeights[24]
          });
        })
        .catch(err => {
          console.error("Error loading pick_values.json", err);
        });
    }

    // Get weight for a given overall pick, with fallback for picks beyond the table
    function getWeightForPick(overall) {
      if (!pickWeights || !Object.keys(pickWeights).length) return 1.0;
      if (pickWeights[overall] != null) return pickWeights[overall];

      if (maxPick != null && overall > maxPick) {
        return pickWeights[maxPick]; // use last known weight for very late picks
      }
      if (minPick != null && overall < minPick) {
        return pickWeights[minPick];
      }
      return 1.0;
    }

    // ------------------ GRADING ------------------

    // Simple grade function based on pickStrength; tweak thresholds as you like
    function gradeFromPickStrength(ps) {
      if (ps == null || Number.isNaN(ps)) return null;

      if (ps >= 1.25) return "A+";
      if (ps >= 1.15) return "A";
      if (ps >= 1.05) return "B";
      if (ps >= 0.95) return "C";
      if (ps >= 0.85) return "D";
      return "F";
    }

    // ------------------ DRAFT LAYOUT ------------------

    function computePickInfo(round, numTeams, slot, draftType) {
      let pickInRound;
      if (draftType === "snake") {
        if (round % 2 === 1) {
          pickInRound = slot;
        } else {
          pickInRound = numTeams - slot + 1;
        }
      } else {
        pickInRound = slot;
      }
      const overall = (round - 1) * numTeams + pickInRound;
      return { pickInRound, overall };
    }

    function buildPicksTable() {
      const numTeams = Number(document.getElementById("numTeams").value);
      const slot = Number(document.getElementById("pickSlot").value);
      const numRounds = Number(document.getElementById("numRounds").value);
      const draftType = document.getElementById("draftType").value;
      const container = document.getElementById("picksTableContainer");

      if (!numTeams || !slot || !numRounds) {
        container.innerHTML = "<p>Please enter valid draft settings first.</p>";
        return;
      }

      let html = "<table>";
      html += "<thead><tr>";
      html += "<th>Round</th>";
      html += "<th>Overall pick</th>";
      html += "<th>Player</th>";
      html += "</tr></thead><tbody>";

      for (let r = 1; r <= numRounds; r++) {
        const { overall } = computePickInfo(r, numTeams, slot, draftType);
        html += "<tr>";
        html += `<td>${r}</td>`;
        html += `<td>${overall}</td>`;
        html += `<td><input type="text"
                             class="player-input"
                             data-round="${r}"
                             data-overall="${overall}"
                             list="playersList"
                             placeholder="Start typing a player name..." /></td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      container.innerHTML = html;
    }

    // ------------------ ANALYSIS ------------------

    function analyzeDraft() {
      const inputs = document.querySelectorAll(".player-input");
      const resultsContainer = document.getElementById("resultsContainer");

      if (!inputs.length) {
        resultsContainer.innerHTML = "<p>Build the picks table and enter players first.</p>";
        return;
      }

      const rows = [];

      inputs.forEach(input => {
        const playerName = input.value.trim();
        if (!playerName) return; // skip empty rows

        const round = Number(input.dataset.round);
        const overall = Number(input.dataset.overall);

        const player = findPlayerByName(playerName);

        let expectedTotal = null;
        let expectedAvg   = null;
        let actualTotal   = null;
        let actualAvg     = null;
        let ratioTotal    = null;
        let ratioAvg      = null;
        let pickStrength  = null;

        if (player) {
          expectedTotal = player.expectedTotal;
          expectedAvg   = player.expectedAvg;
          actualTotal   = player.totalPoints;
          actualAvg     = player.avgPoints;
          ratioTotal    = player.ratioTotal;
          ratioAvg      = player.ratioAvg;
          pickStrength  = player.pickStrength;
        }

        const weight = getWeightForPick(overall);
        const weightedStrength =
          pickStrength != null ? pickStrength * weight : null;

        const grade =
          pickStrength != null ? gradeFromPickStrength(pickStrength) : null;

        rows.push({
          round,
          overall,
          playerName,
          player,
          expectedTotal,
          expectedAvg,
          actualTotal,
          actualAvg,
          ratioTotal,
          ratioAvg,
          pickStrength,
          weight,
          weightedStrength,
          grade
        });
      });

      if (!rows.length) {
        resultsContainer.innerHTML = "<p>No players entered yet.</p>";
        return;
      }

      const totalWeighted = rows.reduce(
        (sum, r) => sum + (r.weightedStrength || 0),
        0
      );

      let html = "";
      html += `<p><strong>Total weighted draft score:</strong> ${totalWeighted.toFixed(3)}</p>`;

      html += "<table>";
      html += "<thead><tr>";
      html += "<th>Round</th>";
      html += "<th>Overall</th>";
      html += "<th>Pick Weight</th>";
      html += "<th>Weighted Strength</th>";
      html += "<th>Player</th>";
      html += "<th>Pos</th>";
      html += "<th>Total</th>";
      html += "<th>Avg</th>";
      html += "<th>Exp Total</th>";
      html += "<th>Exp Avg</th>";
      html += "<th>ratioTotal</th>";
      html += "<th>ratioAvg</th>";
      html += "<th>Pick Strength</th>";
      html += "<th>Grade</th>";
      html += "</tr></thead><tbody>";

      rows.forEach(r => {
        const pos = r.player ? r.player.position : "";

        html += "<tr>";
        html += `<td>${r.round}</td>`;
        html += `<td>${r.overall}</td>`;
        html += `<td>${r.weight != null ? r.weight.toFixed(3) : "—"}</td>`;
        html += `<td>${r.weightedStrength != null ? r.weightedStrength.toFixed(3) : "—"}</td>`;
        html += `<td>${r.playerName}${
          !r.player ? '<span class="not-found"> (not found)</span>' : ""
        }</td>`;
        html += `<td>${pos}</td>`;
        html += `<td>${r.actualTotal != null ? r.actualTotal.toFixed(1) : "—"}</td>`;
        html += `<td>${r.actualAvg != null ? r.actualAvg.toFixed(1) : "—"}</td>`;
        html += `<td>${r.expectedTotal != null ? r.expectedTotal.toFixed(1) : "—"}</td>`;
        html += `<td>${r.expectedAvg != null ? r.expectedAvg.toFixed(1) : "—"}</td>`;
        html += `<td>${r.ratioTotal != null ? r.ratioTotal.toFixed(3) : "—"}</td>`;
        html += `<td>${r.ratioAvg != null ? r.ratioAvg.toFixed(3) : "—"}</td>`;
        html += `<td>${r.pickStrength != null ? r.pickStrength.toFixed(3) : "—"}</td>`;
        html += `<td>${r.grade || "—"}</td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      resultsContainer.innerHTML = html;
    }

    // ------------------ WIRE UP ------------------

    document.getElementById("buildPicksBtn").addEventListener("click", buildPicksTable);
    document.getElementById("analyzeBtn").addEventListener("click", analyzeDraft);

    // Load data on page load
    loadPlayers();
    loadPickValues();
  </script>
</body>
</html>
